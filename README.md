# Универсальный парсер JSON в CSV и XLSX

## Задача и ТЗ

Программа предназначена для пакетного преобразования произвольных JSON-файлов в табличный вид:

- **CSV** — отдельный CSV-файл на каждый входной JSON (в папке `OUT`), имена с таймштампом.
- **XLSX** — один файл `output_YYYYMMDD-HHMM.xlsx` с несколькими листами: каждый обработанный JSON выводится на свой лист.

Требования:

- Универсальность: подходит для любой структуры JSON.
- Имена колонок = путь по ключам (или с заданной вложенности через `path_start`), например: `businessBlock`, `colorCode - primary` при `path_start: ["data", "body"]`.
- Вложенные объекты разворачиваются в составные имена колонок; можно исключать ключи и оставлять только нужные колонки.
- Список входных файлов задаётся в конфиге (`config.json`, ключ `input_files`).
- В Excel: настраиваемая заморозка областей (ячейка-граница по умолчанию и по листам), автофильтр, формат колонок (целое число, текст по умолчанию).
- Подробное логирование (INFO и DEBUG) в папку `log`.
- Параллельная обработка файлов (multiprocessing).
- Использование только стандартной библиотеки Python (без pip).

В конфиге задаются: путь старта разбора (`path_start`), исключаемые ключи (`exclude_keys`), только включаемые колонки (`include_only_keys`), параметры листов XLSX (имя, формат колонок, формат по умолчанию, закрепление ячейки). Подробные комментарии и варианты параметров — в `config.json` (блок `__comments`).

---

## Решение

1. **Разбор JSON**  
   Файл читается как JSON. Если корень — объект и в нём есть ключ `results`, `data`, `items` или `rows`, то значением этого ключа считается массив записей; каждая запись — одна строка таблицы. Если корень — массив, каждый элемент — строка. Иначе весь корень считается одной строкой.

2. **Старт с заданной вложенности (`path_start`)**  
   Если задан массив ключей (например `["data", "body"]`), каждая запись «проваливается» по этому пути; имена колонок и данные строятся только от этой вложенности. Если путь в записи не найден, строка обрабатывается целиком.

3. **Развёртывание (flatten)**  
   Каждая запись обходится рекурсивно. Скалярные значения записываются в ячейку с именем колонки = путь ключей через разделитель (по умолчанию `" - "`). Ключи из `exclude_keys` (по имени или по полному пути) не попадают в выход. При непустом `include_only_keys` в выход идут только указанные колонки.

4. **CSV**  
   Для каждого JSON создаётся один CSV в `OUT` с именем `{имя_файла}_{таймштамп}.csv`. Кодировка по умолчанию `utf-8-sig`, разделитель `;`, первая строка — заголовки.

5. **XLSX**  
   Один файл `OUT/output_{таймштамп}.xlsx`. Лист на каждый JSON; имя листа = имя файла без расширения (до 31 символа). Реализация на stdlib: ZIP + XML OOXML. Закрепление областей по ячейке (по умолчанию или отдельно по листам), автофильтр, ширина колонок, формат ячеек (целое число и др.), общие строки.

6. **Параллельность**  
   При нескольких файлах используется `multiprocessing.Pool`. Каждый процесс обрабатывает свой файл и возвращает данные для листа; главный процесс собирает листы и пишет один XLSX.

7. **Логирование**  
   В папке `log`: `INFO_parser_YYYYMMDD_HH.log`, `DEBUG_parser_YYYYMMDD_HH.log`. Формат строки DEBUG: `дата время - [уровень] - сообщение [class: ... | def: ...]`.

---

## Структура проекта

```
.
├── config.json          # Конфигурация; блок __comments — пояснения и варианты параметров
├── main.py              # Точка входа
├── IN/                  # Входные JSON-файлы
├── OUT/                 # Результаты: CSV и output_YYYYMMDD-HHMM.xlsx
├── log/                 # Логи INFO и DEBUG
├── src/
│   ├── __init__.py
│   ├── config_loader.py # Загрузка config.json, get_sheet_options
│   ├── csv_exporter.py  # Запись CSV
│   ├── json_flattener.py# Развёртывание JSON (path_start, exclude_keys, include_only_keys)
│   ├── logging_setup.py # Настройка логов
│   ├── worker.py        # Обработка одного файла (flatten + CSV)
│   ├── xlsx_exporter.py # Запись XLSX (закрепление по ячейке, форматы колонок)
│   └── Tests/
│       ├── __init__.py
│       └── test_flattener.py  # Тесты flatten, path_start, exclude, include_only
└── README.md
```

---

## Переменные и функции

### config.json

| Ключ | Назначение |
|------|------------|
| `input_dir` | Папка с входными JSON (по умолчанию `IN`). |
| `output_dir` | Папка для CSV и XLSX (по умолчанию `OUT`). |
| `input_files` | Массив имён файлов из `input_dir`. Обрабатываются только существующие. |
| `path_separator` | Разделитель в имени колонки между ключами (по умолчанию `" - "`). |
| `path_start` | Цепочка ключей, с которых начинать разбор (например `["data", "body"]`). Имена колонок и данные строятся от этой вложенности. |
| `exclude_keys` | Ключи или полные пути, не попадающие в выход (например `["photoData"]`, `["colorCode - secondary"]`). |
| `include_only_keys` | Пустой массив — все колонки (с учётом исключений). Иначе — только перечисленные имена колонок. |
| `csv` | Параметры CSV: `encoding`, `delimiter`, `lineterminator`. |
| `xlsx` | Параметры XLSX: `freeze_first_row`, `freeze_cell`, `freeze_pane_per_sheet`, `autofilter`, `sheets`. |
| `xlsx.freeze_cell` | Ячейка-граница закрепления по умолчанию для всех листов (например `"A2"`, `"B2"`). |
| `xlsx.freeze_pane_per_sheet` | Массив `[{ "sheet_index": 0, "cell": "B2" }, ...]` — своя ячейка закрепления для указанных листов. |
| `xlsx.sheets` | Массив настроек листов: `name`, `columns`, `default_column_format`, `column_format`. |
| `xlsx.sheets[].default_column_format` | Формат по умолчанию для всех колонок листа (например `{ "number_format": "text" }`). |
| `xlsx.sheets[].column_format` | Формат по колонкам (переопределяет default): например `{ "gosbCode": { "number_format": "integer" } }`. |
| `column_formats` | Описание опций форматирования (справочник в config). |

В файле конфига блок **`__comments`** содержит подробные комментарии и варианты значений по каждому параметру (программа его не использует).

### Основные функции

- **`src.json_flattener.extract_rows(data)`** — по структуре JSON определяет массив записей (строк).
- **`src.json_flattener.flatten_row(row, path_sep, exclude_keys)`** — разворачивает один объект в словарь «путь ключей → значение».
- **`src.json_flattener.flatten_json_data(data, path_sep, path_start, exclude_keys, include_only_keys)`** — разворот с учётом path_start и фильтров колонок.
- **`src.json_flattener.load_and_flatten(json_path, ...)`** — загрузка JSON из файла и возврат `(rows, columns)`.
- **`src.csv_exporter.write_csv(rows, columns, out_path, ...)`** — запись таблицы в CSV.
- **`src.xlsx_exporter.write_xlsx(sheets_data, out_path, freeze_first_row, freeze_cell, freeze_cell_per_sheet, autofilter, column_widths, column_formats_per_sheet, default_formats_per_sheet, logger)`** — запись нескольких листов в один XLSX с закреплением по ячейке и форматами колонок.
- **`src.config_loader.load_config(config_path)`** — загрузка и нормализация конфига.
- **`src.config_loader.get_sheet_options(config, file_index)`** — настройки листа по индексу файла (name, column_format, default_column_format).
- **`src.worker.process_one_file(json_path, base_dir, config, logger)`** — обработка одного JSON: flatten, запись CSV, возврат данных для листа.

### Запуск

Из корня проекта:

```bash
python main.py
```

Конфиг по умолчанию: `./config.json`. Список файлов — из `input_files`; обрабатываются только существующие в `input_dir`.

Тесты развёртывания JSON:

```bash
python src/Tests/test_flattener.py
```

---

## Конфиг: листы, форматирование, закрепление

- **Закрепление**  
  `freeze_cell` — ячейка-граница по умолчанию (например `"A2"` — закрепить первую строку). Для отдельных листов — массив `freeze_pane_per_sheet`: `{ "sheet_index": 0, "cell": "B2" }`. Если `freeze_cell` не задан, при `freeze_first_row: true` используется `"A2"`.

- **Формат колонок**  
  В `sheets[].column_format` задаётся формат по имени колонки (реализовано `number_format: "integer"`). В `sheets[].default_column_format` — формат по умолчанию для всех колонок листа (например `{ "number_format": "text" }`). Отдельно указанные колонки переопределяют формат по умолчанию.

- **Опции форматирования**  
  В `column_formats` в config описаны возможные опции (align, цвета, width, number_format, date_format и др.). В XLSX полностью поддерживаются закрепление по ячейке и формат «целое число» для выбранных колонок.

---

## История версий

- **0.2.0**
  - Закрепление областей по ячейке: общий параметр `freeze_cell` и массив `freeze_pane_per_sheet` (лист → ячейка).
  - Формат колонок: `default_column_format` для листа (по умолчанию для всех колонок) и `column_format` для отдельных колонок (например целое число).
  - В конфиг добавлен блок `__comments` с подробными комментариями и вариантами параметров.
  - В XLSX: парсинг ячейки (A1, B2 и т.д.), корректные xSplit/ySplit и activePane при закреплении.

- **0.1.0**
  - Универсальный flatten JSON с путями ключей в именах колонок.
  - Старт с заданной вложенности (`path_start`), исключение ключей (`exclude_keys`), только указанные колонки (`include_only_keys`).
  - Поддержка массивов записей через ключи `results`, `data`, `items`, `rows`.
  - Экспорт в CSV (один файл на JSON) и в один XLSX с листом на файл; имена выходных файлов с таймштампом.
  - Закрепление первой строки и автофильтр в XLSX; формат «целое число» для выбранных колонок.
  - Конфиг: `input_files`, параметры CSV/XLSX, настройки листов и форматирование колонок.
  - Логирование в файлы INFO и DEBUG в папке `log`.
  - Параллельная обработка через `multiprocessing.Pool` при нескольких файлах.
  - Использование только стандартной библиотеки (json, csv, pathlib, logging, multiprocessing, zipfile, xml.etree).
  - Тесты в `src/Tests/test_flattener.py`.
